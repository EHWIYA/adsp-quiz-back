name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          ssh-keyscan -p ${{ secrets.SERVER_PORT || '22' }} -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts || true
          chmod 600 ~/.ssh/known_hosts

      - name: Deploy to server
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_PORT: ${{ secrets.SERVER_PORT || '22' }}
        run: |
          ssh -o StrictHostKeyChecking=accept-new -o UserKnownHostsFile=~/.ssh/known_hosts -p ${SERVER_PORT} ${SERVER_USER}@${SERVER_HOST} << 'ENDSSH'
            set -e
            
            PROJECT_DIR="/opt/adsp-quiz-backend"
            ENV_FILE="${PROJECT_DIR}/env/.env"
            
            echo "=== GitHub Actions ë°°í¬ ì‹œì‘ ==="
            
            # 1. í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
            cd "$PROJECT_DIR"
            
            # 2. ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
            echo "ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°..."
            git fetch origin
            git reset --hard origin/main
            # data/postgres/ ë””ë ‰í† ë¦¬ë¥¼ ì œì™¸í•˜ê³  ì •ë¦¬ (ë°ì´í„° ë³´í˜¸)
            git clean -fd --exclude='data/postgres' || true
            
            # 3. í™˜ê²½ë³€ìˆ˜ íŒŒì¼ í™•ì¸ (ì—†ìœ¼ë©´ ìƒì„±)
            if [ ! -f "$ENV_FILE" ]; then
              echo "í™˜ê²½ë³€ìˆ˜ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. í…œí”Œë¦¿ì—ì„œ ìƒì„±í•©ë‹ˆë‹¤..."
              if [ -f "${PROJECT_DIR}/env/.env.template" ]; then
                cp "${PROJECT_DIR}/env/.env.template" "$ENV_FILE"
                chmod 600 "$ENV_FILE"
              else
                echo "í…œí”Œë¦¿ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. ìˆ˜ë™ìœ¼ë¡œ ìƒì„±í•´ì•¼ í•©ë‹ˆë‹¤."
                exit 1
              fi
            fi
            
            # 4. í™˜ê²½ë³€ìˆ˜ ì—…ë°ì´íŠ¸ (GitHub Secretsì—ì„œ)
            echo "í™˜ê²½ë³€ìˆ˜ ì—…ë°ì´íŠ¸..."
            
            # BOM ì œê±° (UTF-8 BOMì´ ìˆìœ¼ë©´ ì œê±°)
            if [ -f "$ENV_FILE" ]; then
              # Pythonì„ ì‚¬ìš©í•˜ì—¬ BOM ì œê±° (heredoc ì¤‘ì²© ë°©ì§€ë¥¼ ìœ„í•´ ì¸ë¼ì¸ ëª…ë ¹ì–´ ì‚¬ìš©)
              if command -v python3 &> /dev/null; then
                python3 -c "import sys; content = open('$ENV_FILE', 'rb').read(); open('$ENV_FILE', 'wb').write(content[3:]) if content.startswith(b'\xef\xbb\xbf') else None" 2>/dev/null || true
              else
                # sedë¥¼ ì‚¬ìš©í•˜ì—¬ BOM ì œê±° (ëŒ€ì•ˆ)
                sed -i '1s/^\xEF\xBB\xBF//' "$ENV_FILE" 2>/dev/null || true
              fi
            fi
            
            # í™˜ê²½ë³€ìˆ˜ ê°’ì„ ë³€ìˆ˜ì— ì €ì¥ ë° export
            DATABASE_URL="${{ secrets.DATABASE_URL }}"
            DB_USER="${{ secrets.DB_USER }}"
            DB_PASSWORD="${{ secrets.DB_PASSWORD }}"
            GEMINI_API_KEY="${{ secrets.GEMINI_API_KEY || '' }}"
            SECRET_KEY="${{ secrets.SECRET_KEY }}"
            ALLOWED_ORIGINS="${{ secrets.ALLOWED_ORIGINS }}"
            
            export DATABASE_URL DB_USER DB_PASSWORD GEMINI_API_KEY SECRET_KEY ALLOWED_ORIGINS
            export ENV_FILE
            
            # Python ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‚¬ìš©í•˜ì—¬ í™˜ê²½ë³€ìˆ˜ íŒŒì¼ ì—…ë°ì´íŠ¸ (íŠ¹ìˆ˜ ë¬¸ì ì²˜ë¦¬ ì•ˆì „)
            # heredoc ì¤‘ì²© ë°©ì§€ë¥¼ ìœ„í•´ Python ì›ë¼ì´ë„ˆ ì‚¬ìš© (walrus operatorë¡œ ë°˜ë³µë¬¸ ì²˜ë¦¬)
            python3 -c "import re, os, sys; sys.stdout.reconfigure(encoding='utf-8') if sys.stdout.encoding != 'utf-8' else None; f = os.environ['ENV_FILE']; c = open(f, 'r', encoding='utf-8').read(); vars_list = [('DATABASE_URL', os.environ['DATABASE_URL']), ('DB_USER', os.environ['DB_USER']), ('DB_PASSWORD', os.environ['DB_PASSWORD']), ('GEMINI_API_KEY', os.environ.get('GEMINI_API_KEY', '')), ('SECRET_KEY', os.environ['SECRET_KEY']), ('ALLOWED_ORIGINS', os.environ['ALLOWED_ORIGINS']), ('ENVIRONMENT', 'production'), ('PORT', '8001')]; [c := (re.sub(rf'^{re.escape(n)}=.*$', f'{n}={v}', c, flags=re.MULTILINE) if re.search(rf'^{re.escape(n)}=.*$', c, re.MULTILINE) else (c + ('\n' if c and not c.endswith('\n') else '') + f'{n}={v}\n')) for n, v in vars_list]; open(f, 'w', encoding='utf-8', newline='\n').write(c); print('âœ… í™˜ê²½ë³€ìˆ˜ ì—…ë°ì´íŠ¸ ì™„ë£Œ')"
            
            # í™˜ê²½ë³€ìˆ˜ ì—…ë°ì´íŠ¸ í›„ ê²€ì¦
            echo "í™˜ê²½ë³€ìˆ˜ ì—…ë°ì´íŠ¸ ê²€ì¦ ì¤‘..."
            if [ ! -f "$ENV_FILE" ]; then
              echo "âŒ í™˜ê²½ë³€ìˆ˜ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤: $ENV_FILE"
              exit 1
            fi
            
            # DATABASE_URL í˜•ì‹ ê²€ì¦ (ì‚¬ìš©ìëª…ê³¼ ë¹„ë°€ë²ˆí˜¸ í¬í•¨ ì—¬ë¶€ í™•ì¸)
            source "$ENV_FILE"
            if [ -z "$DATABASE_URL" ]; then
              echo "âŒ DATABASE_URLì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
              exit 1
            fi
            
            # DATABASE_URL í˜•ì‹ ê²€ì¦: postgresql:// ë˜ëŠ” postgresql+asyncpg://ë¡œ ì‹œì‘í•˜ê³  @ ê¸°í˜¸ê°€ í¬í•¨ë˜ì–´ì•¼ í•¨
            if ! echo "$DATABASE_URL" | grep -qE '^postgresql(\+asyncpg)?://[^@]+@'; then
              echo "âŒ DATABASE_URL í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤."
              echo "í˜„ì¬ DATABASE_URL: ${DATABASE_URL:0:50}..."
              echo "ì˜¬ë°”ë¥¸ í˜•ì‹: postgresql+asyncpg://user:password@host:port/dbname"
              exit 1
            fi
            
            # DB_USERì™€ DB_PASSWORDê°€ ë¹„ì–´ìˆì§€ ì•Šì€ì§€ í™•ì¸
            if [ -z "$DB_USER" ] || [ -z "$DB_PASSWORD" ]; then
              echo "âŒ DB_USER ë˜ëŠ” DB_PASSWORDê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
              exit 1
            fi
            
            echo "âœ… í™˜ê²½ë³€ìˆ˜ ê²€ì¦ ì™„ë£Œ"
            echo "DATABASE_URL í˜•ì‹ í™•ì¸: ${DATABASE_URL%%@*}@***"
            
            # 4-1. ë°ì´í„°ë² ì´ìŠ¤ ë¹„ë°€ë²ˆí˜¸ ê²€ì¦ (í™˜ê²½ë³€ìˆ˜ ì—…ë°ì´íŠ¸ í›„)
            echo "=== ë°ì´í„°ë² ì´ìŠ¤ ë¹„ë°€ë²ˆí˜¸ ê²€ì¦ ==="
            if [ -f "${PROJECT_DIR}/scripts/verify-db-password.sh" ]; then
              echo "âœ… ë¹„ë°€ë²ˆí˜¸ ê²€ì¦ ìŠ¤í¬ë¦½íŠ¸ ë°œê²¬: ${PROJECT_DIR}/scripts/verify-db-password.sh"
              chmod +x "${PROJECT_DIR}/scripts/verify-db-password.sh"
              
              if ! "${PROJECT_DIR}/scripts/verify-db-password.sh"; then
                echo "âŒ ë°ì´í„°ë² ì´ìŠ¤ ë¹„ë°€ë²ˆí˜¸ ê²€ì¦ ì‹¤íŒ¨"
                exit 1
              fi
              
              echo "âœ… ë°ì´í„°ë² ì´ìŠ¤ ë¹„ë°€ë²ˆí˜¸ ê²€ì¦ ì™„ë£Œ"
            else
              echo "âš ï¸  ë¹„ë°€ë²ˆí˜¸ ê²€ì¦ ìŠ¤í¬ë¦½íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤. ìˆ˜ë™ ê²€ì¦ì„ ì§„í–‰í•©ë‹ˆë‹¤..."
              
              # PostgreSQL ì»¨í…Œì´ë„ˆê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸
              if ! docker-compose --env-file "$ENV_FILE" ps postgres 2>/dev/null | grep -q "Up"; then
                echo "âš ï¸  PostgreSQL ì»¨í…Œì´ë„ˆê°€ ì‹¤í–‰ ì¤‘ì´ ì•„ë‹™ë‹ˆë‹¤. ì‹œì‘í•©ë‹ˆë‹¤..."
                docker-compose --env-file "$ENV_FILE" up -d postgres
                echo "PostgreSQL ì»¨í…Œì´ë„ˆ ì‹œì‘ ëŒ€ê¸° ì¤‘..."
                sleep 5
              fi
              
              # .env íŒŒì¼ì—ì„œ ë°ì´í„°ë² ì´ìŠ¤ ì •ë³´ ì¶”ì¶œ
              DB_USER_FROM_ENV=$(grep "^DB_USER=" "$ENV_FILE" | cut -d'=' -f2 | tr -d '"' | tr -d "'" || echo "")
              DB_PASSWORD_FROM_ENV=$(grep "^DB_PASSWORD=" "$ENV_FILE" | cut -d'=' -f2 | tr -d '"' | tr -d "'" || echo "")
              DB_NAME=$(grep "^DATABASE_URL=" "$ENV_FILE" | sed -n 's/.*\/\([^?]*\).*/\1/p' | head -1)
              if [ -z "$DB_NAME" ]; then
                DB_NAME="adsp_quiz_db"
              fi
              
              if [ -z "$DB_USER_FROM_ENV" ] || [ -z "$DB_PASSWORD_FROM_ENV" ]; then
                echo "âŒ .env íŒŒì¼ì—ì„œ DB_USER ë˜ëŠ” DB_PASSWORDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
                exit 1
              fi
              
              # PostgreSQL ì—°ê²° í…ŒìŠ¤íŠ¸
              echo "PostgreSQL ì—°ê²° í…ŒìŠ¤íŠ¸ ì¤‘..."
              MAX_CONNECTION_RETRIES=3
              CONNECTION_RETRY_DELAY=2
              
              for i in $(seq 1 $MAX_CONNECTION_RETRIES); do
                if docker-compose --env-file "$ENV_FILE" exec -T postgres psql -U "$DB_USER_FROM_ENV" -d "$DB_NAME" -c "SELECT 1;" > /dev/null 2>&1; then
                  echo "âœ… ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì„±ê³µ (ë¹„ë°€ë²ˆí˜¸ ì¸ì¦ í†µê³¼)"
                  break
                else
                  if [ $i -eq $MAX_CONNECTION_RETRIES ]; then
                    echo "âŒ ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì‹¤íŒ¨ (ë¹„ë°€ë²ˆí˜¸ ì¸ì¦ ì‹¤íŒ¨)"
                    echo "ğŸ”§ ì¡°ì¹˜ ë°©ë²•: GitHub Secretsì˜ DB_PASSWORDì™€ ì„œë²„ PostgreSQL ì»¨í…Œì´ë„ˆì˜ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸"
                    exit 1
                  else
                    echo "âš ï¸  ì—°ê²° ì‹¤íŒ¨ (ì‹œë„ $i/$MAX_CONNECTION_RETRIES), ì¬ì‹œë„ ì¤‘..."
                    sleep $CONNECTION_RETRY_DELAY
                  fi
                fi
              done
            fi
            
            # 5. ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
            echo "=== ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ í™•ì¸ ==="
            if [ -f "${PROJECT_DIR}/scripts/deploy.sh" ]; then
              echo "âœ… ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ë°œê²¬: ${PROJECT_DIR}/scripts/deploy.sh"
              echo "ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì¤‘..."
              chmod +x "${PROJECT_DIR}/scripts/deploy.sh"
              
              if ! "${PROJECT_DIR}/scripts/deploy.sh"; then
                echo "âŒ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì‹¤íŒ¨"
                exit 1
              fi
              
              echo "âœ… ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì™„ë£Œ"
            else
              echo "âš ï¸  ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤. ìˆ˜ë™ ë°°í¬ë¥¼ ì§„í–‰í•©ë‹ˆë‹¤..."
              echo "ìˆ˜ë™ ë°°í¬ ì‹œì‘..."
              
              # ìˆ˜ë™ ë°°í¬
              docker-compose --env-file "$ENV_FILE" down || true
              docker-compose --env-file "$ENV_FILE" build --no-cache
              docker-compose --env-file "$ENV_FILE" up -d
              
              # ì»¨í…Œì´ë„ˆ ì‹œì‘ ëŒ€ê¸°
              sleep 10
              
              # ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ í™•ì¸ (ì„ì‹œ ì¡°ì¹˜ - Dockerfile ìˆ˜ì • í›„ ì œê±° ê°€ëŠ¥)
              if ! docker-compose --env-file "$ENV_FILE" exec -T app test -d /app/migrations/versions 2>/dev/null; then
                echo "âš ï¸  ë§ˆì´ê·¸ë ˆì´ì…˜ ë””ë ‰í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤. í™•ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤."
                docker-compose --env-file "$ENV_FILE" exec -T app ls -la /app/ || true
                docker-compose --env-file "$ENV_FILE" exec -T app ls -la /app/migrations/ 2>/dev/null || echo "migrations ë””ë ‰í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤."
              fi
              
              # ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰ (ì‹¤íŒ¨ ì‹œ ë°°í¬ ì‹¤íŒ¨)
              if ! docker-compose --env-file "$ENV_FILE" exec -T app alembic upgrade head; then
                echo "âŒ ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤íŒ¨"
                echo "ë§ˆì´ê·¸ë ˆì´ì…˜ ë¡œê·¸:"
                docker-compose --env-file "$ENV_FILE" logs app | tail -20
                exit 1
              fi
              
              echo "âœ… ìˆ˜ë™ ë°°í¬ ì™„ë£Œ"
            fi
            
            # 6. í—¬ìŠ¤ì²´í¬
            echo "=== í—¬ìŠ¤ì²´í¬ ì‹œì‘ ==="
            HEALTH_CHECK_URL="https://adsp-api.livbee.co.kr/health"
            MAX_RETRIES=5
            RETRY_DELAY=10
            
            for i in $(seq 1 $MAX_RETRIES); do
              echo "í—¬ìŠ¤ì²´í¬ ì‹œë„ $i/$MAX_RETRIES..."
              sleep $RETRY_DELAY
              
              HEALTH_RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" "$HEALTH_CHECK_URL" || echo "000")
              echo "í—¬ìŠ¤ì²´í¬ ì‘ë‹µ: HTTP $HEALTH_RESPONSE"
              
              if [ "$HEALTH_RESPONSE" = "200" ]; then
                echo "âœ… ë°°í¬ ì„±ê³µ! í—¬ìŠ¤ì²´í¬ í†µê³¼ (HTTP $HEALTH_RESPONSE)"
                break
              else
                if [ $i -eq $MAX_RETRIES ]; then
                  echo "âŒ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨ (ìµœëŒ€ ì¬ì‹œë„ íšŸìˆ˜ ë„ë‹¬)"
                  echo "ìµœì¢… ì‘ë‹µ ì½”ë“œ: HTTP $HEALTH_RESPONSE"
                  echo "ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œê·¸:"
                  docker-compose --env-file "$ENV_FILE" logs app | tail -50
                  echo "ì»¨í…Œì´ë„ˆ ìƒíƒœ:"
                  docker-compose --env-file "$ENV_FILE" ps
                  exit 1
                else
                  echo "âš ï¸  í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨ (HTTP $HEALTH_RESPONSE), ì¬ì‹œë„ ì¤‘..."
                fi
              fi
            done
            
            echo "=== ë°°í¬ ì™„ë£Œ ==="
          ENDSSH

      - name: Deployment status
        if: success()
        run: |
          echo "âœ… ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
          echo "ì• í”Œë¦¬ì¼€ì´ì…˜ URL: https://adsp-api.livbee.co.kr"

      - name: Deployment failed
        if: failure()
        run: |
          echo "âŒ ë°°í¬ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì„œë²„ ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”."
